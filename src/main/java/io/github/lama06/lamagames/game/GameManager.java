package io.github.lama06.lamagames.game;

import io.github.lama06.lamagames.LamaGamesPlugin;
import org.bukkit.Bukkit;
import org.bukkit.World;
import org.bukkit.configuration.ConfigurationSection;
import org.bukkit.configuration.serialization.ConfigurationSerializable;

import java.util.HashSet;
import java.util.Iterator;
import java.util.Set;

public class GameManager {
    private final LamaGamesPlugin plugin;
    private final Set<Game> games = new HashSet<>();

    public GameManager(LamaGamesPlugin plugin) {
        this.plugin = plugin;
    }

    public ConfigurationSection getGamesConfiguration() {
        return plugin.getConfig().getConfigurationSection("games");
    }

    public void loadGames() {
        ConfigurationSection gamesConfiguration = getGamesConfiguration();

        for (String worldName : gamesConfiguration.getKeys(false)) {
            ConfigurationSection worldConfig = gamesConfiguration.getConfigurationSection(worldName);

            World world = Bukkit.getWorld(worldName);
            if (world == null) {
                deleteGame(worldName); // Die zu diesem Spiel geh√∂rende Welt exestiert nicht mehr
                continue;
            }

            GameType type = GameType.getByName(worldConfig.getString("type"));
            if (type == null) {
                deleteGame(worldName);
                continue;
            }

            ConfigurationSerializable gameConfig = worldConfig.getSerializable("config", type.getConfigType());

            Game game = type.getGameCreator().create(plugin, world, gameConfig);
            games.add(game);
            game.load();
        }
    }

    public void unloadGames() {
        Iterator<Game> iterator = games.iterator();
        while (iterator.hasNext()) {
            Game game = iterator.next();
            game.unload();
            iterator.remove();
        }
    }

    public void createGame(World world, GameType type) {
        ConfigurationSerializable gameConfig = type.getConfigCreator().get();

        ConfigurationSection worldConfig = getGamesConfiguration().createSection(world.getName());
        worldConfig.set("type", type.getName());
        worldConfig.set("config", gameConfig);

        Game game = type.getGameCreator().create(plugin, world, gameConfig);
        games.add(game);
        game.load();
    }

    public void deleteGame(String worldName) {
        World world = Bukkit.getWorld(worldName);
        if (world != null) {
            Game game = getGameByWorld(world);
            if (game != null) {
                games.remove(game);
                game.unload();
            }
        }

        getGamesConfiguration().set(worldName, null);
    }

    public Game getGameByWorld(World world) {
        for (Game game : games) {
            if (game.getWorld().equals(world)) {
                return game;
            }
        }

        return null;
    }

    public Set<Game> getGames() {
        return games;
    }
}
